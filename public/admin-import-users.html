<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar Usuarios - ENAR B2B Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      padding: 15px 20px;
      position: relative;
    }
    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #D9232D;
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .header-left h1 {
      color: white;
      font-size: 20px;
      font-weight: 600;
    }
    .header-left span {
      background: #D9232D;
      color: white;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .header-nav a {
      color: white;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 6px;
    }
    .header-nav a:hover {
      background: rgba(255,255,255,0.1);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 10px;
    }
    .page-subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 25px;
      margin-bottom: 25px;
    }
    .card h2 {
      font-size: 18px;
      color: #1e3a8a;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }
    .instructions {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .instructions h3 {
      font-size: 14px;
      color: #0369a1;
      margin-bottom: 10px;
    }
    .instructions ol {
      margin-left: 20px;
      font-size: 13px;
      color: #0c4a6e;
    }
    .instructions li {
      margin-bottom: 5px;
    }
    .instructions code {
      background: #e0f2fe;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    .column-info {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .column-info h3 {
      font-size: 14px;
      color: #92400e;
      margin-bottom: 10px;
    }
    .column-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      font-size: 12px;
    }
    .column-item {
      display: flex;
      gap: 5px;
    }
    .column-item .col-num {
      font-weight: 600;
      color: #92400e;
      min-width: 20px;
    }
    .column-item .col-name {
      color: #78350f;
    }
    .column-item.required {
      background: #fef9c3;
      padding: 2px 6px;
      border-radius: 4px;
    }
    textarea {
      width: 100%;
      height: 300px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }
    .btn-primary {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
    }
    .btn-primary:hover {
      box-shadow: 0 4px 15px rgba(30,58,138,0.3);
    }
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .preview-section {
      display: none;
      margin-top: 25px;
    }
    .preview-section.active {
      display: block;
    }
    .preview-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat {
      background: #f0f9ff;
      padding: 15px 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #1e3a8a;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 20px;
    }
    .preview-table th {
      background: #f8fafc;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
    }
    .preview-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .preview-table tr:hover {
      background: #fafafa;
    }
    .preview-table .error-row {
      background: #fef2f2;
    }
    .preview-table .error-cell {
      color: #dc2626;
    }
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    .progress-section {
      display: none;
      margin-top: 25px;
    }
    .progress-section.active {
      display: block;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.3s ease;
    }
    .progress-text {
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .results-log {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .log-success {
      color: #34d399;
    }
    .log-error {
      color: #f87171;
    }
    .log-info {
      color: #60a5fa;
    }
    .results-summary {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    .summary-card {
      flex: 1;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .summary-card.success {
      background: #d1fae5;
      color: #065f46;
    }
    .summary-card.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .summary-value {
      font-size: 36px;
      font-weight: 700;
    }
    .summary-label {
      font-size: 14px;
    }
    .no-access {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .no-access h2 {
      color: #D9232D;
      margin-bottom: 10px;
    }
    #mainContent {
      display: none;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <h1>ENAR B2B</h1>
        <span>IMPORTAR USUARIOS</span>
      </div>
      <nav class="header-nav">
        <a href="admin.html">Volver a Admin</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Loading -->
    <div id="loading" class="card" style="text-align: center; padding: 60px;">
      <p>Verificando permisos...</p>
    </div>

    <!-- No Access -->
    <div id="noAccess" class="no-access" style="display: none;">
      <h2>Acceso Denegado</h2>
      <p>No tienes permisos para acceder a esta secci√≥n.</p>
      <br>
      <a href="/" style="color: #1e3a8a;">Volver al Cat√°logo</a>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
      <h1 class="page-title">Importar Usuarios Masivamente</h1>
      <p class="page-subtitle">Copia los datos desde Google Sheets y p√©galos aqu√≠ para crear m√∫ltiples usuarios a la vez.</p>

      <!-- Step 1: Instructions & Input -->
      <div class="card" id="step1">
        <h2>Paso 1: Preparar y Pegar Datos</h2>

        <div class="instructions">
          <h3>üìã Instrucciones:</h3>
          <ol>
            <li>Abre tu Google Sheet con los datos de usuarios</li>
            <li>Aseg√∫rate de que la <strong>primera fila tenga los encabezados</strong></li>
            <li>Selecciona todas las celdas incluyendo encabezados (Ctrl+A)</li>
            <li>Copia (Ctrl+C)</li>
            <li>Pega aqu√≠ abajo (Ctrl+V)</li>
          </ol>
        </div>

        <div class="column-info">
          <h3>üìä Columnas Esperadas (en cualquier orden):</h3>
          <div class="column-grid">
            <div class="column-item required"><span class="col-name">email *</span></div>
            <div class="column-item required"><span class="col-name">nombre *</span></div>
            <div class="column-item required"><span class="col-name">password *</span></div>
            <div class="column-item"><span class="col-name">telefono</span></div>
            <div class="column-item"><span class="col-name">tipo_cliente</span></div>
            <div class="column-item"><span class="col-name">razon_social</span></div>
            <div class="column-item"><span class="col-name">nit</span></div>
            <div class="column-item"><span class="col-name">direccion</span></div>
            <div class="column-item"><span class="col-name">ciudad</span></div>
            <div class="column-item"><span class="col-name">departamento</span></div>
          </div>
          <p style="margin-top: 10px; font-size: 12px; color: #92400e;">
            * Campos obligatorios. <strong>tipo_cliente</strong> puede ser: mayorista, negocio, persona_natural
          </p>
        </div>

        <textarea id="csvInput" placeholder="Pega aqu√≠ los datos copiados de Google Sheets...

Ejemplo:
email	nombre	password	telefono	tipo_cliente	razon_social
cliente1@email.com	Juan P√©rez	pass123	3001234567	negocio	Mi Empresa SAS
cliente2@email.com	Mar√≠a L√≥pez	pass456	3109876543	mayorista	Distribuidora XYZ"></textarea>

        <div class="btn-row">
          <button class="btn btn-primary" id="btnPreview">Previsualizar Datos</button>
          <button class="btn btn-secondary" id="btnClear">Limpiar</button>
        </div>
      </div>

      <!-- Step 2: Preview -->
      <div class="card preview-section" id="step2">
        <h2>Paso 2: Revisar Datos</h2>

        <div class="preview-stats">
          <div class="stat">
            <div class="stat-value" id="totalRows">0</div>
            <div class="stat-label">Usuarios a crear</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="validRows">0</div>
            <div class="stat-label">V√°lidos</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="errorRows" style="color: #dc2626;">0</div>
            <div class="stat-label">Con errores</div>
          </div>
        </div>

        <div class="table-container">
          <table class="preview-table">
            <thead id="previewHeader"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>

        <div class="btn-row">
          <button class="btn btn-success" id="btnImport">Importar Usuarios V√°lidos</button>
          <button class="btn btn-secondary" id="btnBack">Volver a Editar</button>
        </div>
      </div>

      <!-- Step 3: Progress -->
      <div class="card progress-section" id="step3">
        <h2>Paso 3: Importando...</h2>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText">Preparando importaci√≥n...</div>

        <div class="results-log" id="resultsLog"></div>

        <div class="results-summary" id="resultsSummary" style="display: none;">
          <div class="summary-card success">
            <div class="summary-value" id="successCount">0</div>
            <div class="summary-label">Creados exitosamente</div>
          </div>
          <div class="summary-card error">
            <div class="summary-value" id="errorCount">0</div>
            <div class="summary-label">Con errores</div>
          </div>
        </div>

        <div class="btn-row" id="finishRow" style="display: none;">
          <button class="btn btn-primary" onclick="window.location.href='admin.html'">Ir a Panel Admin</button>
          <button class="btn btn-secondary" onclick="location.reload()">Importar M√°s</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { esAdmin } from './js/user-manager.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCMPflYHuPnAWaUhv90wi3uBOhP9AoA8e0",
      authDomain: "enar-b2b.firebaseapp.com",
      projectId: "enar-b2b",
      storageBucket: "enar-b2b.firebasestorage.app",
      messagingSenderId: "903832444518",
      appId: "1:903832444518:web:f76cb209febc9281a497a7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Store admin credentials for re-auth
    let adminEmail = null;
    let adminPassword = null;

    // Parsed data
    let parsedData = [];
    let headers = [];
    let validUsers = [];

    // Elements
    const loading = document.getElementById('loading');
    const noAccess = document.getElementById('noAccess');
    const mainContent = document.getElementById('mainContent');
    const csvInput = document.getElementById('csvInput');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');

    // Required fields
    const REQUIRED_FIELDS = ['email', 'nombre', 'password'];
    const VALID_TIPOS = ['mayorista', 'negocio', 'persona_natural'];

    // Parse CSV/TSV data (Google Sheets copies as TSV)
    function parseData(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) {
        alert('Debe incluir al menos una fila de encabezados y una fila de datos');
        return null;
      }

      // Detect delimiter (tab or comma)
      const firstLine = lines[0];
      const delimiter = firstLine.includes('\t') ? '\t' : ',';

      // Parse headers
      headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
      console.log('Headers detectados:', headers);

      // Check required headers
      const missingHeaders = REQUIRED_FIELDS.filter(f => !headers.includes(f));
      if (missingHeaders.length > 0) {
        alert(`Faltan columnas obligatorias: ${missingHeaders.join(', ')}`);
        return null;
      }

      // Parse rows
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(delimiter);
        if (values.length < headers.length) continue; // Skip incomplete rows

        const row = {};
        let hasData = false;
        headers.forEach((header, idx) => {
          row[header] = (values[idx] || '').trim();
          if (row[header]) hasData = true;
        });

        if (hasData) {
          row._rowNum = i + 1;
          row._errors = validateRow(row);
          data.push(row);
        }
      }

      return data;
    }

    // Validate a row
    function validateRow(row) {
      const errors = [];

      if (!row.email) {
        errors.push('Email requerido');
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(row.email)) {
        errors.push('Email inv√°lido');
      }

      if (!row.nombre) {
        errors.push('Nombre requerido');
      }

      if (!row.password) {
        errors.push('Password requerido');
      } else if (row.password.length < 6) {
        errors.push('Password muy corto (min 6)');
      }

      if (row.tipo_cliente && !VALID_TIPOS.includes(row.tipo_cliente.toLowerCase())) {
        errors.push('Tipo inv√°lido');
      }

      return errors;
    }

    // Render preview table
    function renderPreview(data) {
      const previewHeader = document.getElementById('previewHeader');
      const previewBody = document.getElementById('previewBody');

      // Header
      previewHeader.innerHTML = `
        <tr>
          <th>#</th>
          ${headers.map(h => `<th>${h}</th>`).join('')}
          <th>Estado</th>
        </tr>
      `;

      // Body
      previewBody.innerHTML = data.map(row => {
        const hasErrors = row._errors.length > 0;
        return `
          <tr class="${hasErrors ? 'error-row' : ''}">
            <td>${row._rowNum}</td>
            ${headers.map(h => `<td>${row[h] || '-'}</td>`).join('')}
            <td class="${hasErrors ? 'error-cell' : ''}">${hasErrors ? row._errors.join(', ') : '‚úì V√°lido'}</td>
          </tr>
        `;
      }).join('');

      // Stats
      const valid = data.filter(r => r._errors.length === 0);
      const invalid = data.filter(r => r._errors.length > 0);

      document.getElementById('totalRows').textContent = data.length;
      document.getElementById('validRows').textContent = valid.length;
      document.getElementById('errorRows').textContent = invalid.length;

      validUsers = valid;
    }

    // Show step
    function showStep(stepNum) {
      step1.style.display = stepNum === 1 ? 'block' : 'none';
      step2.classList.toggle('active', stepNum === 2);
      step3.classList.toggle('active', stepNum === 3);
    }

    // Log message
    function log(message, type = 'info') {
      const resultsLog = document.getElementById('resultsLog');
      const className = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
      resultsLog.innerHTML += `<div class="${className}">${message}</div>`;
      resultsLog.scrollTop = resultsLog.scrollHeight;
    }

    // Import users
    async function importUsers() {
      if (validUsers.length === 0) {
        alert('No hay usuarios v√°lidos para importar');
        return;
      }

      // Ask for admin password for re-authentication
      adminPassword = prompt('Ingresa tu contrase√±a de admin para continuar con la importaci√≥n:');
      if (!adminPassword) {
        alert('Se requiere la contrase√±a para continuar');
        return;
      }

      showStep(3);

      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const resultsLog = document.getElementById('resultsLog');

      resultsLog.innerHTML = '';
      let successCount = 0;
      let errorCount = 0;

      log(`Iniciando importaci√≥n de ${validUsers.length} usuarios...`, 'info');

      for (let i = 0; i < validUsers.length; i++) {
        const user = validUsers[i];
        const progress = Math.round(((i + 1) / validUsers.length) * 100);
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Procesando ${i + 1} de ${validUsers.length}...`;

        try {
          // Create user in Firebase Auth
          log(`[${i + 1}/${validUsers.length}] Creando: ${user.email}...`, 'info');

          const userCredential = await createUserWithEmailAndPassword(auth, user.email, user.password);
          const uid = userCredential.user.uid;

          // Create Firestore document
          const userData = {
            uid: uid,
            email: user.email,
            nombre: user.nombre,
            telefono: user.telefono || '',
            tipo_cliente: (user.tipo_cliente || 'persona_natural').toLowerCase(),
            estado: 'aprobado',
            razon_social: user.razon_social || '',
            nit: user.nit || '',
            direccion: user.direccion || '',
            ciudad: user.ciudad || '',
            departamento: user.departamento || '',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            aprobado_en: new Date().toISOString(),
            limite_credito: 0,
            plazo_pago: 0,
            descuento_adicional: 0,
            importado: true
          };

          await setDoc(doc(db, 'usuarios', uid), userData);

          log(`‚úì ${user.email} creado exitosamente`, 'success');
          successCount++;

          // Re-authenticate as admin after each user creation
          if (adminEmail && adminPassword) {
            try {
              await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
            } catch (reAuthError) {
              console.warn('Error re-autenticando admin:', reAuthError);
            }
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 500));

        } catch (error) {
          let errorMsg = error.message;
          if (error.code === 'auth/email-already-in-use') {
            errorMsg = 'Email ya registrado';
          } else if (error.code === 'auth/invalid-email') {
            errorMsg = 'Email inv√°lido';
          } else if (error.code === 'auth/weak-password') {
            errorMsg = 'Contrase√±a muy d√©bil';
          }

          log(`‚úó ${user.email}: ${errorMsg}`, 'error');
          errorCount++;

          // Try to re-authenticate as admin
          if (adminEmail && adminPassword) {
            try {
              await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
            } catch (reAuthError) {
              console.warn('Error re-autenticando admin:', reAuthError);
            }
          }
        }
      }

      // Final re-auth as admin
      if (adminEmail && adminPassword) {
        try {
          await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
          log('Sesi√≥n de admin restaurada', 'info');
        } catch (e) {
          log('Nota: Debes volver a iniciar sesi√≥n como admin', 'info');
        }
      }

      // Show summary
      progressText.textContent = 'Importaci√≥n completada';
      document.getElementById('successCount').textContent = successCount;
      document.getElementById('errorCount').textContent = errorCount;
      document.getElementById('resultsSummary').style.display = 'flex';
      document.getElementById('finishRow').style.display = 'flex';

      log(`\n=== RESUMEN ===`, 'info');
      log(`Exitosos: ${successCount}`, 'success');
      log(`Errores: ${errorCount}`, errorCount > 0 ? 'error' : 'info');
    }

    // Event Listeners
    document.getElementById('btnPreview').addEventListener('click', () => {
      const text = csvInput.value.trim();
      if (!text) {
        alert('Por favor, pega los datos de usuarios');
        return;
      }

      parsedData = parseData(text);
      if (parsedData && parsedData.length > 0) {
        renderPreview(parsedData);
        showStep(2);
      }
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      csvInput.value = '';
    });

    document.getElementById('btnBack').addEventListener('click', () => {
      showStep(1);
    });

    document.getElementById('btnImport').addEventListener('click', importUsers);

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      loading.style.display = 'none';

      if (!user) {
        window.location.href = '/login.html';
        return;
      }

      if (!esAdmin(user)) {
        noAccess.style.display = 'block';
        return;
      }

      adminEmail = user.email;
      mainContent.style.display = 'block';
    });
  </script>
</body>
</html>
