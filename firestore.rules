rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper: Admin check
    function isAdmin() {
      return request.auth != null &&
        request.auth.token.email == 'sebastianbumq@enarapp.com';
    }

    // Helper: Gestor de usuarios (puede gestionar usuarios pero no órdenes ni productos)
    function isUserManager() {
      return request.auth != null &&
        request.auth.token.email == 'ventas@enar.com.co';
    }

    // Helper: Usuario autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Usuario aprobado
    function isApproved() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.estado == 'aprobado';
    }

    // Productos: lectura pública, escritura solo admin
    match /productos/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Configuración: solo admin
    match /configuracion/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Usuarios: usuarios pueden leer/escribir su propio doc, admin puede todo
    match /usuarios/{userId} {
      // Cualquier autenticado puede crear su propio documento (registro)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Usuario puede leer su propio documento, admin puede leer todos,
      // gestores solo pueden leer usuarios que ellos crearon
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin() ||
        (isUserManager() && resource.data.creado_por == request.auth.token.email)
      );

      // Usuario puede actualizar su propio documento (datos limitados)
      // Admin puede actualizar cualquier documento
      // Gestores solo pueden actualizar usuarios que ellos crearon
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['estado', 'tipo_cliente', 'limite_credito', 'plazo_pago', 'descuento_adicional'])) ||
        isAdmin() ||
        (isUserManager() && resource.data.creado_por == request.auth.token.email)
      );

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // Carrito: cada usuario solo su propio carrito
    match /carrito/{userId} {
      allow read, write: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin()
      );
    }

    // Órdenes: usuarios aprobados pueden crear y leer sus propias órdenes
    match /ordenes/{ordenId} {
      // Usuarios aprobados pueden crear órdenes (solo sus propias)
      allow create: if isApproved() &&
        request.resource.data.user_id == request.auth.uid;

      // Usuarios pueden leer sus propias órdenes, admin y vendedores pueden leer todas
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isAdmin() ||
        isUserManager()
      );

      // Admin y vendedores pueden actualizar cualquier orden; usuarios aprobados pueden actualizar sus propias órdenes pendientes
      allow update: if isAdmin() || isUserManager() ||
        (isApproved() && resource.data.user_id == request.auth.uid && resource.data.estado == 'pendiente');

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // Cotizaciones (legacy): solo autenticados
    match /cotizaciones/{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
